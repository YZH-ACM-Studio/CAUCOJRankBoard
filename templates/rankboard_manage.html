{% extends "layout/basic.html" %}

{% block content %}
<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>

<style>
  .manage-container {
    max-width: 1800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .manage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .manage-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  .manage-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: #0ea5e9;
    color: white;
  }

  .btn-primary:hover {
    background: #0284c7;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
  }

  .btn-secondary:hover {
    background: #4b5563;
  }

  .btn-success {
    background: #10b981;
    color: white;
  }

  .btn-success:hover {
    background: #059669;
  }

  .btn-danger {
    background: #ef4444;
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .manage-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 1.5rem;
  }

  .people-list {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }

  .person-item {
    padding: 0.75rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.5rem;
    border: 1px solid transparent;
  }

  .person-item:hover {
    background: #f0f9ff;
    border-color: #0ea5e9;
  }

  .person-item.active {
    background: #dbeafe;
    border-color: #0ea5e9;
  }

  .edit-panel {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .form-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.95rem;
  }

  .form-input:focus {
    outline: none;
    border-color: #0ea5e9;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }

  .awards-section {
    margin-top: 2rem;
  }

  .awards-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .awards-header h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  .award-item {
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    background: #fafafa;
    display: flex;
    gap: 0.75rem;
  }

  .drag-handle {
    cursor: move;
    color: #9ca3af;
    display: flex;
    align-items: flex-start;
    padding-top: 0.5rem;
  }

  .award-item-content {
    flex: 1;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #0ea5e9;
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 1rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 1rem;
  }

  .modal-content {
    background: white;
    border-radius: 1rem;
    max-width: 1200px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-close {
    width: 2rem;
    height: 2rem;
    border-radius: 0.375rem;
    border: none;
    background-color: #f3f4f6;
    color: #6b7280;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .modal-close:hover {
    background-color: #e5e7eb;
    color: #1f2937;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }
</style>

<div class="manage-container">
  <a href="{{ url('rankboard_main') }}" class="back-link">
    <span>â†</span>
    <span>è¿”å›æ’åæ¦œ</span>
  </a>

  <div class="manage-header">
    <h1>ğŸ“ æ•°æ®ç®¡ç†</h1>
    <div class="manage-actions">
      <button class="btn btn-success" id="exportBtn">
        <span>ğŸ“¤</span>
        <span>å¯¼å‡ºæ•°æ®</span>
      </button>
      <button class="btn btn-primary" id="importBtn">
        <span>ğŸ“¥</span>
        <span>å¯¼å…¥æ•°æ®</span>
      </button>
      <button class="btn btn-secondary" id="saveBtn">
        <span>ğŸ’¾</span>
        <span>ä¿å­˜æ‰€æœ‰</span>
      </button>
      <button class="btn btn-primary" id="settingsBtn">
        <span class="iconify" data-icon="mdi:cog" data-width="16"></span>
        <span>æƒé‡è®¾ç½®</span>
      </button>
    </div>
  </div>

  <div class="manage-grid">
    <div class="people-list">
      <h3 style="margin-bottom: 1rem;">äººå‘˜åˆ—è¡¨ (<span id="peopleCount">0</span>)</h3>
      <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" id="addPersonBtn">
        + æ·»åŠ æ–°äººå‘˜
      </button>
      <div id="peopleListContainer"></div>
    </div>

    <div class="edit-panel" id="editPanel">
      <p style="text-align: center; color: #9ca3af; padding: 3rem;">è¯·é€‰æ‹©ä¸€ä¸ªäººå‘˜è¿›è¡Œç¼–è¾‘</p>
    </div>
  </div>
</div>

<input type="file" id="importFileInput" accept=".json" style="display: none;">

<!-- è®¾ç½®æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="settingsModal" style="display: none;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
        <span class="iconify" data-icon="mdi:cog" data-width="24"></span>
        <span>æƒé‡è®¾ç½®</span>
      </h2>
      <button class="modal-close" onclick="closeSettingsModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">åŸºç¡€å‚æ•°</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem;">åŸºå‡†åˆ†</label>
            <input type="number" id="baseScoreInput" class="form-input" step="1" />
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem;">è¡°å‡ç³»æ•°</label>
            <input type="number" id="decayFactorInput" class="form-input" step="0.01" />
          </div>
        </div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
          <span class="iconify" data-icon="mdi:ladder" data-width="20" style="vertical-align: middle;"></span>
          å¤©æ¢¯èµ›
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" id="ladderWeights"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
          <span class="iconify" data-icon="mdi:trophy" data-width="20" style="vertical-align: middle;"></span>
          ICPC
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" id="icpcWeights"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
          <span class="iconify" data-icon="mdi:medal" data-width="20" style="vertical-align: middle;"></span>
          CCPC
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" id="ccpcWeights"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
          <span class="iconify" data-icon="mdi:star" data-width="20" style="vertical-align: middle;"></span>
          ç™¾åº¦ä¹‹æ˜Ÿ
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" id="baiduWeights"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
          <span class="iconify" data-icon="mdi:code-tags" data-width="20" style="vertical-align: middle;"></span>
          PAT
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" id="patWeights"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSettingsModal()">
        <span class="iconify" data-icon="mdi:close" data-width="16"></span>
        <span>å–æ¶ˆ</span>
      </button>
      <button class="btn btn-primary" onclick="saveSettings()">
        <span class="iconify" data-icon="mdi:content-save" data-width="16"></span>
        <span>ä¿å­˜è®¾ç½®</span>
      </button>
    </div>
  </div>
</div>

<script>
// å·¥å…·å‡½æ•°
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// å…¨å±€å˜é‡
let awardWeights = {{ (config.weights or {}) | dump | safe }};
let awardLowerBounds = {{ (config.lowerBounds or {}) | dump | safe }};
let baseScore = {{ (config.params.baseScore if config.params else 100) }};
let decayFactor = {{ (config.params.decayFactor if config.params else 0.3) }};

let currentPerson = null;
let currentPersonIndex = -1;
let allPeople = {{ people | dump | safe }};
let draggedAwardIndex = null;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  renderPeopleList();
  
  // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
  document.getElementById('exportBtn').addEventListener('click', exportData);
  document.getElementById('importBtn').addEventListener('click', importData);
  document.getElementById('saveBtn').addEventListener('click', saveAllData);
  document.getElementById('addPersonBtn').addEventListener('click', addNewPerson);
  document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
  
  // å¯¼å…¥æ–‡ä»¶è¾“å…¥æ¡†äº‹ä»¶
  document.getElementById('importFileInput').addEventListener('change', handleFileImport);
});

function renderPeopleList() {
  const container = document.getElementById('peopleListContainer');
  document.getElementById('peopleCount').textContent = allPeople.length;
  
  container.innerHTML = allPeople.map((person, index) => `
    <div class="person-item ${currentPersonIndex === index ? 'active' : ''}" 
         onclick="selectPerson(${index})">
      <div style="font-weight: 600;">${escapeHtml(person.username)}</div>
      <div style="font-size: 0.875rem; color: #6b7280;">${escapeHtml(person.studentInfo)}</div>
      <div style="font-size: 0.75rem; color: #9ca3af;">è·å¥–: ${person.awards ? person.awards.length : 0} | OJ: ${person.ojProblems || 0}</div>
    </div>
  `).join('');
}

function selectPerson(index) {
  currentPersonIndex = index;
  currentPerson = allPeople[index];
  renderPeopleList();
  renderEditPanel();
}

function renderEditPanel() {
  if (currentPerson === null || currentPersonIndex === -1) return;
  
  const panel = document.getElementById('editPanel');
  panel.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">ç¼–è¾‘ï¼š${escapeHtml(currentPerson.username)}</h2>
      <button class="btn btn-danger btn-sm" onclick="deletePerson()">
        <span class="iconify" data-icon="mdi:delete" data-width="16"></span>
        åˆ é™¤æ­¤äººå‘˜
      </button>
    </div>
    
    <div class="form-group">
      <label class="form-label">ç”¨æˆ·å</label>
      <input type="text" class="form-input" value="${escapeHtml(currentPerson.username)}" 
             oninput="updatePersonField('username', this.value)">
    </div>
    
    <div class="form-group">
      <label class="form-label">å­¦å·å§“å</label>
      <input type="text" class="form-input" value="${escapeHtml(currentPerson.studentInfo)}" 
             oninput="updatePersonField('studentInfo', this.value)">
    </div>
    
    <div class="form-group">
      <label class="form-label">OJ é¢˜æ•°</label>
      <input type="number" class="form-input" value="${currentPerson.ojProblems || 0}" 
             oninput="updatePersonField('ojProblems', parseInt(this.value) || 0)">
    </div>
    
    <div class="awards-section">
      <div class="awards-header">
        <h3>è·å¥–è®°å½• (${currentPerson.awards ? currentPerson.awards.length : 0})</h3>
        <button class="btn btn-primary btn-sm" onclick="addAward()">
          <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
          æ·»åŠ å¥–é¡¹
        </button>
      </div>
      <div id="awardsContainer"></div>
    </div>
  `;
  
  renderAwards();
}

function renderAwards() {
  if (!currentPerson || !currentPerson.awards) return;
  
  const container = document.getElementById('awardsContainer');
  
  if (currentPerson.awards.length === 0) {
    container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 2rem;">æš‚æ— è·å¥–è®°å½•</p>';
    return;
  }
  
  container.innerHTML = currentPerson.awards.map((award, index) => {
    const isICPC = award.type && award.type.startsWith('ICPC');
    const isCCPC = award.type && award.type.startsWith('CCPC');
    const isEC = award.type && award.type.startsWith('ICPC-EC');
    const isLadder = award.type && award.type.startsWith('å¤©æ¢¯èµ›');
    const isPAT = award.type && award.type.startsWith('PAT');
    const isBaidu = award.type && award.type.startsWith('ç™¾åº¦ä¹‹æ˜Ÿ');
    const showRank = isICPC || isCCPC;  // åªæœ‰ICPCå’ŒCCPCæ˜¾ç¤ºæ’å
    const showScore = isLadder || isPAT || isBaidu;  // å¤©æ¢¯èµ›ã€PATã€ç™¾åº¦ä¹‹æ˜Ÿæ˜¾ç¤ºåˆ†æ•°
    const showTeammates = isICPC || isCCPC;  // åªæœ‰ICPCå’ŒCCPCæ˜¾ç¤ºé˜Ÿå‹
    const baseType = isEC ? award.type.replace('ICPC-EC', 'ICPC') : award.type;
    
    return `
    <div class="award-item" draggable="true" ondragstart="handleDragStart(${index})" 
         ondragover="handleDragOver(event)" ondrop="handleDrop(${index})">
      <div class="drag-handle">
        <span class="iconify" data-icon="mdi:drag-vertical" data-width="24"></span>
      </div>
      <div class="award-item-content">
        <div style="display: grid; grid-template-columns: ${isICPC ? '1fr auto' : '1fr'}; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
          <div>
            <label class="form-label">å¥–é¡¹ç±»å‹</label>
            <select class="form-input" onchange="updateAwardType(${index}, this.value)">
              ${Object.keys(awardWeights).filter(t => !t.startsWith('ICPC-EC')).map(type => 
                `<option value="${type}" ${baseType === type ? 'selected' : ''}>${type}</option>`
              ).join('')}
            </select>
          </div>
          ${isICPC ? `
          <div>
            <label class="form-label">ECè®¤è¯</label>
            <label style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap; padding: 0.5rem 0.75rem; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; height: 38px;">
              <input type="checkbox" ${isEC ? 'checked' : ''} 
                     onchange="toggleEC(${index}, this.checked)">
              <span style="font-size: 0.875rem; font-weight: 500;">EC</span>
            </label>
          </div>
          ` : ''}
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div>
            <label class="form-label">èµ›äº‹åç§°</label>
            <input type="text" class="form-input" value="${escapeHtml(award.contest || '')}" 
                   oninput="updateAwardField(${index}, 'contest', this.value)" placeholder="ä¾‹å¦‚: 2024 ICPCäºšæ´²åŒºåŸŸèµ›å—äº¬ç«™">
          </div>
          <div>
            <label class="form-label">æ—¥æœŸ</label>
            <input type="text" class="form-input" value="${escapeHtml(award.date || '')}" 
                   oninput="updateAwardField(${index}, 'date', this.value)" placeholder="ä¾‹å¦‚: 2024-01">
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: ${showRank ? '2fr 1fr 1fr auto' : showScore ? '2fr 1fr auto' : '1fr auto'}; gap: 0.5rem; align-items: end;">
          <div>
            <label class="form-label">å›¢é˜Ÿåç§°${showTeammates ? '' : 'ï¼ˆå¯é€‰ï¼‰'}</label>
            <input type="text" class="form-input" value="${escapeHtml(award.team || '')}" 
                   oninput="updateAwardField(${index}, 'team', this.value)" placeholder="ä¾‹å¦‚: Team Alpha">
          </div>
          ${showRank ? `
          <div>
            <label class="form-label">èµ›æ—¶æ’å</label>
            <input type="number" class="form-input" value="${award.liveRank || ''}" 
                   oninput="updateAwardField(${index}, 'liveRank', this.value ? parseInt(this.value) : undefined)" placeholder="ä¾‹å¦‚: 15">
          </div>
          <div>
            <label class="form-label">å­¦æ ¡æ’å</label>
            <input type="number" class="form-input" value="${award.schoolRank || ''}" 
                   oninput="updateAwardField(${index}, 'schoolRank', this.value ? parseInt(this.value) : undefined)" placeholder="ä¾‹å¦‚: 3">
          </div>
          ` : ''}
          ${showScore ? `
          <div>
            <label class="form-label">åˆ†æ•°</label>
            <input type="number" class="form-input" value="${award.score || ''}" 
                   oninput="updateAwardField(${index}, 'score', this.value ? parseInt(this.value) : undefined)" placeholder="ä¾‹å¦‚: 285">
          </div>
          ` : ''}
          <button class="btn btn-danger btn-sm" onclick="deleteAward(${index})">
            <span class="iconify" data-icon="mdi:delete" data-width="16"></span>
          </button>
        </div>
        
        ${showTeammates ? `
        <div style="margin-top: 0.5rem;">
          <label class="form-label">é˜Ÿå‹ï¼ˆå¯é€‰ï¼‰</label>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
            ${(award.teammates || []).map((teammate, tmIndex) => `
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #ede9fe; color: #7c3aed; border-radius: 0.25rem; font-size: 0.875rem;">
                ${teammate}
                <button onclick="removeTeammate(${index}, ${tmIndex})" style="background: none; border: none; color: #7c3aed; cursor: pointer; padding: 0; display: flex; align-items: center;">
                  <span class="iconify" data-icon="mdi:close-circle" data-width="16"></span>
                </button>
              </span>
            `).join('')}
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" class="form-input" id="teammate-input-${index}" 
                   placeholder="è¾“å…¥é˜Ÿå‹å§“å (æ ¼å¼: å­¦å· å§“å (ç”¨æˆ·å))" style="flex: 1;">
            <button class="btn btn-primary btn-sm" onclick="addTeammate(${index})" style="white-space: nowrap;">
              <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
              æ·»åŠ 
            </button>
          </div>
        </div>
        ` : ''}
      </div>
    </div>
  `;
  }).join('');
}

function updatePersonField(field, value) {
  if (currentPerson) {
    currentPerson[field] = value;
    allPeople[currentPersonIndex] = currentPerson;
    renderPeopleList();
  }
}

function updateAwardField(index, field, value) {
  if (currentPerson && currentPerson.awards && currentPerson.awards[index]) {
    currentPerson.awards[index][field] = value;
    allPeople[currentPersonIndex] = currentPerson;
  }
}

function updateAwardType(index, newType) {
  if (currentPerson && currentPerson.awards && currentPerson.awards[index]) {
    currentPerson.awards[index].type = newType;
    allPeople[currentPersonIndex] = currentPerson;
    renderAwards(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å­—æ®µæ˜¾ç¤º
  }
}

function toggleEC(index, isEC) {
  if (currentPerson && currentPerson.awards && currentPerson.awards[index]) {
    const award = currentPerson.awards[index];
    if (isEC && award.type && award.type.startsWith('ICPC') && !award.type.startsWith('ICPC-EC')) {
      award.type = award.type.replace('ICPC-', 'ICPC-EC-');
    } else if (!isEC && award.type && award.type.startsWith('ICPC-EC')) {
      award.type = award.type.replace('ICPC-EC-', 'ICPC-');
    }
    allPeople[currentPersonIndex] = currentPerson;
    renderAwards();
  }
}

function addTeammate(awardIndex) {
  if (currentPerson && currentPerson.awards && currentPerson.awards[awardIndex]) {
    const input = document.getElementById(`teammate-input-${awardIndex}`);
    const teammate = input.value.trim();
    
    if (!teammate) {
      alert('è¯·è¾“å…¥é˜Ÿå‹ä¿¡æ¯');
      return;
    }
    
    if (!currentPerson.awards[awardIndex].teammates) {
      currentPerson.awards[awardIndex].teammates = [];
    }
    
    currentPerson.awards[awardIndex].teammates.push(teammate);
    allPeople[currentPersonIndex] = currentPerson;
    input.value = '';
    renderAwards();
  }
}

function removeTeammate(awardIndex, teammateIndex) {
  if (currentPerson && currentPerson.awards && currentPerson.awards[awardIndex]) {
    if (currentPerson.awards[awardIndex].teammates) {
      currentPerson.awards[awardIndex].teammates.splice(teammateIndex, 1);
      allPeople[currentPersonIndex] = currentPerson;
      renderAwards();
    }
  }
}

function addAward() {
  if (currentPerson) {
    if (!currentPerson.awards) {
      currentPerson.awards = [];
    }
    currentPerson.awards.push({
      type: 'ICPC-é‡‘å¥–',
      contest: '',
      date: '',
      team: '',
      liveRank: undefined,
      schoolRank: undefined
    });
    allPeople[currentPersonIndex] = currentPerson;
    renderEditPanel();
  }
}

function deleteAward(index) {
  if (currentPerson && currentPerson.awards && confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå¥–é¡¹å—?')) {
    currentPerson.awards.splice(index, 1);
    allPeople[currentPersonIndex] = currentPerson;
    renderAwards();
  }
}

function deletePerson() {
  if (confirm(`ç¡®å®šåˆ é™¤ ${currentPerson.username} å—?æ­¤æ“ä½œæ— æ³•æ’¤é”€!`)) {
    allPeople.splice(currentPersonIndex, 1);
    currentPerson = null;
    currentPersonIndex = -1;
    renderPeopleList();
    document.getElementById('editPanel').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 3rem;">è¯·é€‰æ‹©ä¸€ä¸ªäººå‘˜è¿›è¡Œç¼–è¾‘</p>';
  }
}

function addNewPerson() {
  const newPerson = {
    username: 'æ–°ç”¨æˆ·',
    studentInfo: 'å­¦å· å§“å',
    ojProblems: 0,
    awards: []
  };
  allPeople.push(newPerson);
  renderPeopleList();
  selectPerson(allPeople.length - 1);
}

// æ‹–æ‹½åŠŸèƒ½
function handleDragStart(index) {
  draggedAwardIndex = index;
}

function handleDragOver(event) {
  event.preventDefault();
}

function handleDrop(index) {
  if (draggedAwardIndex !== null && draggedAwardIndex !== index && currentPerson && currentPerson.awards) {
    const awards = currentPerson.awards;
    const draggedItem = awards[draggedAwardIndex];
    awards.splice(draggedAwardIndex, 1);
    const newIndex = draggedAwardIndex < index ? index - 1 : index;
    awards.splice(newIndex, 0, draggedItem);
    currentPerson.awards = awards;
    allPeople[currentPersonIndex] = currentPerson;
    renderAwards();
    draggedAwardIndex = null;
  }
}

// å¯¼å‡ºæ•°æ®
function exportData() {
  const exportData = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    data: {
      awards: allPeople,
      weights: awardWeights,
      lowerBounds: awardLowerBounds,
      params: {
        baseScore: baseScore,
        decayFactor: decayFactor
      }
    }
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `rankboard_data_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
}

// å¯¼å…¥æ•°æ®
function importData() {
  console.log('å¯¼å…¥æŒ‰é’®è¢«ç‚¹å‡»');
  document.getElementById('importFileInput').click();
}

// å¥–é¡¹ç±»å‹æ ¼å¼è½¬æ¢å‡½æ•° - å°†æ—§æ ¼å¼è½¬æ¢ä¸ºæ–°æ ¼å¼
function convertAwardType(oldType) {
  // æ˜ å°„è¡¨: æ—§æ ¼å¼ -> æ–°æ ¼å¼
  const typeMap = {
    // ICPC
    'ICPCé‡‘å¥–': 'ICPC-é‡‘å¥–',
    'ICPCé“¶å¥–': 'ICPC-é“¶å¥–',
    'ICPCé“œå¥–': 'ICPC-é“œå¥–',
    'ICPC-ECé‡‘å¥–': 'ICPC-EC-é‡‘å¥–',
    'ICPC-ECé“¶å¥–': 'ICPC-EC-é“¶å¥–',
    'ICPC-ECé“œå¥–': 'ICPC-EC-é“œå¥–',
    // CCPC
    'CCPCé‡‘å¥–': 'CCPC-é‡‘å¥–',
    'CCPCé“¶å¥–': 'CCPC-é“¶å¥–',
    'CCPCé“œå¥–': 'CCPC-é“œå¥–',
    // ç™¾åº¦ä¹‹æ˜Ÿ
    'ç™¾åº¦ä¹‹æ˜Ÿé‡‘å¥–': 'ç™¾åº¦ä¹‹æ˜Ÿ-é‡‘å¥–',
    'ç™¾åº¦ä¹‹æ˜Ÿé“¶å¥–': 'ç™¾åº¦ä¹‹æ˜Ÿ-é“¶å¥–',
    'ç™¾åº¦ä¹‹æ˜Ÿé“œå¥–': 'ç™¾åº¦ä¹‹æ˜Ÿ-é“œå¥–',
    // å¤©æ¢¯èµ›å›¢é˜Ÿ
    'å¤©æ¢¯èµ›å›¢é˜Ÿç‰¹ç­‰å¥–': 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½ç‰¹ç­‰å¥–',
    'å¤©æ¢¯èµ›å›¢é˜Ÿé‡‘å¥–': 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½ä¸€ç­‰å¥–',
    'å¤©æ¢¯èµ›å›¢é˜Ÿé“¶å¥–': 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½äºŒç­‰å¥–',
    'å¤©æ¢¯èµ›å›¢é˜Ÿé“œå¥–': 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½ä¸‰ç­‰å¥–',
    // å¤©æ¢¯èµ›ä¸ªäºº
    'å¤©æ¢¯èµ›ä¸ªäººç‰¹ç­‰å¥–': 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½ç‰¹ç­‰å¥–',
    'å¤©æ¢¯èµ›ä¸ªäººé‡‘å¥–': 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½ä¸€ç­‰å¥–',
    'å¤©æ¢¯èµ›ä¸ªäººé“¶å¥–': 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½äºŒç­‰å¥–',
    'å¤©æ¢¯èµ›ä¸ªäººé“œå¥–': 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½ä¸‰ç­‰å¥–'
  };
  
  return typeMap[oldType] || oldType; // å¦‚æœå·²ç»æ˜¯æ–°æ ¼å¼æˆ–æœªçŸ¥æ ¼å¼,è¿”å›åŸå€¼
}

function handleFileImport(event) {
  const file = event.target.files[0];
  if (!file) {
    console.log('æœªé€‰æ‹©æ–‡ä»¶');
    return;
  }
  
  console.log('å¼€å§‹è¯»å–æ–‡ä»¶:', file.name);
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      console.log('è§£æçš„æ•°æ®:', data);
      
      if (data.version && data.data) {
        // æ–°ç‰ˆæœ¬æ ¼å¼
        if (Array.isArray(data.data)) {
          // åªæœ‰äººå‘˜æ•°æ®
          allPeople = data.data;
        } else {
          // åŒ…å«é…ç½®
          allPeople = data.data.awards || [];
          
          // è½¬æ¢æ‰€æœ‰å¥–é¡¹ç±»å‹ä¸ºæ–°æ ¼å¼
          console.log('å¼€å§‹è½¬æ¢å¥–é¡¹æ ¼å¼...');
          allPeople.forEach(person => {
            if (person.awards && Array.isArray(person.awards)) {
              person.awards.forEach(award => {
                const oldType = award.type;
                award.type = convertAwardType(oldType);
                if (oldType !== award.type) {
                  console.log(`  è½¬æ¢: ${oldType} -> ${award.type}`);
                }
              });
            }
          });
          console.log('æ ¼å¼è½¬æ¢å®Œæˆ');
          
          if (data.data.weights) {
            // è½¬æ¢æƒé‡é…ç½®çš„key
            const oldWeights = data.data.weights;
            awardWeights = {};
            Object.keys(oldWeights).forEach(key => {
              const newKey = convertAwardType(key);
              awardWeights[newKey] = oldWeights[key];
            });
            console.log('å¯¼å…¥æƒé‡é…ç½® (å·²è½¬æ¢):', awardWeights);
          }
          if (data.data.lowerBounds) {
            // è½¬æ¢ä¸‹é™é…ç½®çš„key
            const oldBounds = data.data.lowerBounds;
            awardLowerBounds = {};
            Object.keys(oldBounds).forEach(key => {
              const newKey = convertAwardType(key);
              awardLowerBounds[newKey] = oldBounds[key];
            });
            console.log('å¯¼å…¥ä¸‹é™é…ç½® (å·²è½¬æ¢):', awardLowerBounds);
          }
          if (data.data.params) {
            baseScore = data.data.params.baseScore || 100;
            decayFactor = data.data.params.decayFactor || 0.3;
            document.getElementById('baseScoreInput').value = baseScore;
            document.getElementById('decayFactorInput').value = decayFactor;
            console.log('å¯¼å…¥å‚æ•°é…ç½®:', { baseScore, decayFactor });
          }
        }
      } else if (Array.isArray(data)) {
        // æ—§ç‰ˆæœ¬æ ¼å¼ï¼ˆç›´æ¥æ˜¯æ•°ç»„ï¼‰
        allPeople = data;
        // è½¬æ¢å¥–é¡¹æ ¼å¼
        console.log('å¼€å§‹è½¬æ¢å¥–é¡¹æ ¼å¼...');
        allPeople.forEach(person => {
          if (person.awards && Array.isArray(person.awards)) {
            person.awards.forEach(award => {
              const oldType = award.type;
              award.type = convertAwardType(oldType);
              if (oldType !== award.type) {
                console.log(`  è½¬æ¢: ${oldType} -> ${award.type}`);
              }
            });
          }
        });
        console.log('æ ¼å¼è½¬æ¢å®Œæˆ');
      } else {
        alert('ä¸æ”¯æŒçš„æ•°æ®æ ¼å¼');
        return;
      }
      
      currentPerson = null;
      currentPersonIndex = -1;
      renderPeopleList();
      document.getElementById('editPanel').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 3rem;">è¯·é€‰æ‹©ä¸€ä¸ªäººå‘˜è¿›è¡Œç¼–è¾‘</p>';
      
      // å¦‚æœå¯¼å…¥äº†é…ç½®,è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
      if (data.version && data.data && (data.data.weights || data.data.lowerBounds || data.data.params)) {
        console.log('æ£€æµ‹åˆ°é…ç½®æ•°æ®,è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“...');
        saveImportedConfig().then(() => {
          alert(`æˆåŠŸå¯¼å…¥ ${allPeople.length} æ¡è®°å½•ï¼é…ç½®å·²è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚`);
        }).catch(error => {
          console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
          alert(`æˆåŠŸå¯¼å…¥ ${allPeople.length} æ¡è®°å½•ï¼ä½†é…ç½®ä¿å­˜å¤±è´¥: ${error.message}`);
        });
      } else {
        alert(`æˆåŠŸå¯¼å…¥ ${allPeople.length} æ¡è®°å½•ï¼`);
      }
    } catch (error) {
      console.error('å¯¼å…¥å¤±è´¥:', error);
      alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
    }
  };
  reader.readAsText(file);
  
  // é‡ç½®input
  event.target.value = '';
}

// ä¿å­˜å¯¼å…¥çš„é…ç½®åˆ°æ•°æ®åº“
async function saveImportedConfig() {
  console.log('========== ä¿å­˜å¯¼å…¥çš„é…ç½®åˆ°æ•°æ®åº“ ==========');
  console.log('åŸºå‡†åˆ†:', baseScore);
  console.log('è¡°å‡ç³»æ•°:', decayFactor);
  console.log('æƒé‡é…ç½®:', awardWeights);
  console.log('ä¸‹é™é…ç½®:', awardLowerBounds);
  
  const requestData = {
    action: 'updateConfig',
    config: {
      weights: awardWeights,
      lowerBounds: awardLowerBounds,
      params: {
        baseScore: baseScore,
        decayFactor: decayFactor
      }
    }
  };
  
  console.log('å‘é€è¯·æ±‚æ•°æ®:', JSON.stringify(requestData, null, 2));
  
  const response = await fetch('{{ url("rankboard_manage") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestData)
  });
  
  const result = await response.json();
  console.log('æœåŠ¡å™¨å“åº”:', result);
  
  if (!result.success) {
    throw new Error(result.error || 'ä¿å­˜é…ç½®å¤±è´¥');
  }
  
  console.log('é…ç½®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“');
  console.log('==========================================');
}

// ä¿å­˜æ‰€æœ‰æ•°æ®
async function saveAllData() {
  try {
    const response = await fetch('{{ url("rankboard_manage") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ people: allPeople })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message || 'ä¿å­˜æˆåŠŸï¼');
    } else {
      alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('ä¿å­˜å¤±è´¥:', error);
    alert('ä¿å­˜å¤±è´¥: ' + error.message);
  }
}

// ===== è®¾ç½®æ¨¡æ€æ¡†åŠŸèƒ½ =====
function openSettingsModal() {
  document.getElementById('baseScoreInput').value = baseScore;
  document.getElementById('decayFactorInput').value = decayFactor;
  renderWeightConfig();
  document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettingsModal() {
  document.getElementById('settingsModal').style.display = 'none';
}

function renderWeightConfig() {
  // æ¸²æŸ“å¤©æ¢¯èµ›æƒé‡
  const ladderContainer = document.getElementById('ladderWeights');
  ladderContainer.innerHTML = '';
  ['å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½ç‰¹ç­‰å¥–', 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½ä¸€ç­‰å¥–', 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½äºŒç­‰å¥–', 'å¤©æ¢¯èµ›-å›¢é˜Ÿå…¨å›½ä¸‰ç­‰å¥–', 
   'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½ç‰¹ç­‰å¥–', 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½ä¸€ç­‰å¥–', 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½äºŒç­‰å¥–', 'å¤©æ¢¯èµ›-ä¸ªäººå…¨å›½ä¸‰ç­‰å¥–'].forEach(type => {
    ladderContainer.innerHTML += `
      <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem;">
        <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">${type}</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
          <input type="number" class="form-input" value="${awardWeights[type] || 1.0}" step="0.1" 
                 onchange="awardWeights['${type}'] = parseFloat(this.value)" placeholder="æƒé‡">
          <input type="number" class="form-input" value="${awardLowerBounds[type] || 0.5}" step="0.1" 
                 onchange="awardLowerBounds['${type}'] = parseFloat(this.value)" placeholder="ä¸‹é™">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem;">
          <div>æƒé‡</div>
          <div>ä¸‹é™</div>
        </div>
      </div>
    `;
  });
  
  // æ¸²æŸ“ICPCæƒé‡
  const icpcContainer = document.getElementById('icpcWeights');
  icpcContainer.innerHTML = '';
  ['ICPC-é‡‘å¥–', 'ICPC-é“¶å¥–', 'ICPC-é“œå¥–', 'ICPC-EC-é‡‘å¥–', 'ICPC-EC-é“¶å¥–', 'ICPC-EC-é“œå¥–'].forEach(type => {
    icpcContainer.innerHTML += `
      <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem;">
        <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">${type}</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
          <input type="number" class="form-input" value="${awardWeights[type] || 1.0}" step="0.1" 
                 onchange="awardWeights['${type}'] = parseFloat(this.value)" placeholder="æƒé‡">
          <input type="number" class="form-input" value="${awardLowerBounds[type] || 0.5}" step="0.1" 
                 onchange="awardLowerBounds['${type}'] = parseFloat(this.value)" placeholder="ä¸‹é™">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem;">
          <div>æƒé‡</div>
          <div>ä¸‹é™</div>
        </div>
      </div>
    `;
  });
  
  // æ¸²æŸ“CCPCæƒé‡
  const ccpcContainer = document.getElementById('ccpcWeights');
  ccpcContainer.innerHTML = '';
  ['CCPC-é‡‘å¥–', 'CCPC-é“¶å¥–', 'CCPC-é“œå¥–'].forEach(type => {
    ccpcContainer.innerHTML += `
      <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem;">
        <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">${type}</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
          <input type="number" class="form-input" value="${awardWeights[type] || 1.0}" step="0.1" 
                 onchange="awardWeights['${type}'] = parseFloat(this.value)" placeholder="æƒé‡">
          <input type="number" class="form-input" value="${awardLowerBounds[type] || 0.5}" step="0.1" 
                 onchange="awardLowerBounds['${type}'] = parseFloat(this.value)" placeholder="ä¸‹é™">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem;">
          <div>æƒé‡</div>
          <div>ä¸‹é™</div>
        </div>
      </div>
    `;
  });
  
  // æ¸²æŸ“ç™¾åº¦ä¹‹æ˜Ÿæƒé‡
  const baiduContainer = document.getElementById('baiduWeights');
  baiduContainer.innerHTML = '';
  ['ç™¾åº¦ä¹‹æ˜Ÿ-é‡‘å¥–', 'ç™¾åº¦ä¹‹æ˜Ÿ-é“¶å¥–', 'ç™¾åº¦ä¹‹æ˜Ÿ-é“œå¥–'].forEach(type => {
    baiduContainer.innerHTML += `
      <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem;">
        <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">${type}</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
          <input type="number" class="form-input" value="${awardWeights[type] || 1.0}" step="0.1" 
                 onchange="awardWeights['${type}'] = parseFloat(this.value)" placeholder="æƒé‡">
          <input type="number" class="form-input" value="${awardLowerBounds[type] || 0.5}" step="0.1" 
                 onchange="awardLowerBounds['${type}'] = parseFloat(this.value)" placeholder="ä¸‹é™">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem;">
          <div>æƒé‡</div>
          <div>ä¸‹é™</div>
        </div>
      </div>
    `;
  });
  
  // æ¸²æŸ“PATæƒé‡
  const patContainer = document.getElementById('patWeights');
  patContainer.innerHTML = '';
  ['PATé¡¶çº§æ»¡åˆ†', 'PATç”²çº§æ»¡åˆ†', 'PATä¹™çº§æ»¡åˆ†'].forEach(type => {
    patContainer.innerHTML += `
      <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem;">
        <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">${type}</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
          <input type="number" class="form-input" value="${awardWeights[type] || 1.0}" step="0.1" 
                 onchange="awardWeights['${type}'] = parseFloat(this.value)" placeholder="æƒé‡">
          <input type="number" class="form-input" value="${awardLowerBounds[type] || 0.5}" step="0.1" 
                 onchange="awardLowerBounds['${type}'] = parseFloat(this.value)" placeholder="ä¸‹é™">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem;">
          <div>æƒé‡</div>
          <div>ä¸‹é™</div>
        </div>
      </div>
    `;
  });
}

async function saveSettings() {
  baseScore = parseInt(document.getElementById('baseScoreInput').value) || 100;
  decayFactor = parseFloat(document.getElementById('decayFactorInput').value) || 0.3;
  
  console.log('========== ä¿å­˜æƒé‡é…ç½® ==========');
  console.log('åŸºå‡†åˆ†:', baseScore);
  console.log('è¡°å‡ç³»æ•°:', decayFactor);
  console.log('æƒé‡é…ç½®:', awardWeights);
  console.log('ä¸‹é™é…ç½®:', awardLowerBounds);
  
  try {
    const requestData = {
      action: 'updateConfig',
      config: {
        weights: awardWeights,
        lowerBounds: awardLowerBounds,
        params: {
          baseScore: baseScore,
          decayFactor: decayFactor
        }
      }
    };
    
    console.log('å‘é€è¯·æ±‚æ•°æ®:', JSON.stringify(requestData, null, 2));
    
    const response = await fetch('{{ url("rankboard_manage") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    });
    
    const result = await response.json();
    console.log('æœåŠ¡å™¨å“åº”:', result);
    
    if (result.success) {
      alert(result.message || 'è®¾ç½®å·²ä¿å­˜!');
      closeSettingsModal();
    } else {
      alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('ä¿å­˜è®¾ç½®å‡ºé”™:', error);
    alert('ä¿å­˜è®¾ç½®å‡ºé”™: ' + error.message);
  }
  console.log('===================================');
}
</script>

{% endblock %}
